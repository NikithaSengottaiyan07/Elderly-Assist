{"version":3,"names":["_reactNativeSound","_interopRequireDefault","require","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","ReactNativeSoundTTSProvider","constructor","settings","initialize","locale","createLinkedList","src","top","i","length","url","next","temp","playNext","linkedSrc","audioPlayer","Sound","error","cancel","play","success","_linkedSrc$next","_this$speechEndHandle","speechEndHandlers","forEach","handle","speakSsml","ssml","linkedLists","ssmlUri","ssmlToSpeech","stop","textToSpeechRequest","generateTTSRequest","result","fetch","serverRootUrl","provider","method","headers","body","JSON","stringify","status","response","json","e","request","applicationId","appId","applicationSecret","appKey","ssmlRequest","voice","addFinishListener","callback","_this$speechEndHandle2","push","clearHandlers","exports"],"sources":["ReactNativeSoundTTSProvider.ts"],"sourcesContent":["import type { TTSData, TTSRequest } from \"../models/customAssistantApiModels\";\r\nimport type VoicifyTextToSpeechProvider from './VoicifyTextToSpeechProvider';\r\nimport Sound from 'react-native-sound'\r\ntype LinkedUrls = {\r\n    src?: string\r\n    next?: LinkedUrls\r\n}\r\nexport class ReactNativeSoundTTSProvider implements VoicifyTextToSpeechProvider {\r\n    settings: VoicifyTextToSpeechSettings\r\n    audioPlayer?: Sound\r\n    speechEndHandlers: (() => void)[] = []\r\n    cancel?: boolean\r\n\r\n    constructor(settings: VoicifyTextToSpeechSettings) {\r\n        this.settings = settings;\r\n    }\r\n\r\n    initialize(locale: string) {\r\n        this.settings.locale = locale\r\n    }\r\n    createLinkedList(src: TTSData[]) {\r\n        let top: LinkedUrls = {};\r\n        for (let i = src.length - 1; i >= 0; i--) {\r\n            if (i == src.length - 1) {\r\n                top = {\r\n                    src: src[i].url,\r\n                    next: {}\r\n                }\r\n            }\r\n            else {\r\n                let temp = {\r\n                    src: src[i].url,\r\n                    next: top\r\n                };\r\n                top = temp;\r\n            }\r\n        }\r\n        return top;\r\n    }\r\n    playNext(linkedSrc: LinkedUrls)\r\n    {\r\n        this.audioPlayer = new Sound(linkedSrc.src, \"\", (error) => {\r\n            if (error) {\r\n                return;\r\n            }\r\n            if (this.audioPlayer) {\r\n                if(!this.cancel)\r\n                {\r\n                    this.audioPlayer.play((success: any) => {\r\n                        if (success) {\r\n                            if(linkedSrc.next?.src)\r\n                            {\r\n                                this.playNext(linkedSrc.next)\r\n    \r\n                            }\r\n                            else\r\n                            {\r\n                                this.speechEndHandlers?.forEach(handle => handle());\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        });\r\n        \r\n    }\r\n    async speakSsml(ssml: string) {\r\n        let linkedLists: LinkedUrls = {}\r\n        const ssmlUri = await this.ssmlToSpeech(ssml)\r\n        if (ssmlUri) {\r\n            linkedLists = this.createLinkedList(ssmlUri)\r\n        }\r\n        if (linkedLists) {\r\n            this.playNext(linkedLists)\r\n        }\r\n    }\r\n\r\n    async stop() {\r\n        if (this.audioPlayer) {\r\n            this.audioPlayer.stop()\r\n        }\r\n    }\r\n\r\n    async ssmlToSpeech(ssml: string) {\r\n        try {\r\n            const textToSpeechRequest = this.generateTTSRequest(ssml);\r\n            const result = await fetch(`${this.settings.serverRootUrl}/api/Ssml/toSpeech/${this.settings.provider}`, {\r\n                method: \"POST\",\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify(textToSpeechRequest)\r\n            });\r\n            if (result.status == 200) {\r\n                const response = await result.json() as TTSData[];\r\n                return (response)\r\n            }\r\n            else {\r\n                return null\r\n            }\r\n        }\r\n        catch (e: any) {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    generateTTSRequest(ssml: string): TTSRequest {\r\n        const request: TTSRequest = {\r\n            applicationId: this.settings.appId,\r\n            applicationSecret: this.settings.appKey,\r\n            ssmlRequest: {\r\n                ssml: ssml,\r\n                locale: this.settings.locale,\r\n                voice: this.settings.voice\r\n            }\r\n        }\r\n        return (request)\r\n    }\r\n\r\n    addFinishListener(callback: () => void) {\r\n        this.speechEndHandlers?.push(callback);\r\n    }\r\n\r\n    clearHandlers() {\r\n        this.speechEndHandlers = []\r\n    }\r\n}\r\n\r\nexport interface VoicifyTextToSpeechSettings {\r\n    appId: string\r\n    appKey: string\r\n    locale: string\r\n    voice: string\r\n    serverRootUrl: string\r\n    provider: 'Google' | 'Polly'\r\n}\r\n\r\n"],"mappings":"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"}